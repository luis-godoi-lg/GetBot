using System.Windows.Input;
using GestaoChamados.Mobile.Helpers;
using GestaoChamados.Mobile.Services;
using GestaoChamados.Shared.DTOs;

namespace GestaoChamados.Mobile.ViewModels;

public class NovoChamadoViewModel : BaseViewModel
{
    private readonly AuthService _authService;
    private string _titulo = string.Empty;
    private string _descricao = string.Empty;
    private string _prioridade = "Media";
    private string _mensagemErro = string.Empty;

    public string Titulo
    {
        get => _titulo;
        set => SetProperty(ref _titulo, value);
    }

    public string Descricao
    {
        get => _descricao;
        set => SetProperty(ref _descricao, value);
    }

    public string Prioridade
    {
        get => _prioridade;
        set => SetProperty(ref _prioridade, value);
    }

    public string MensagemErro
    {
        get => _mensagemErro;
        set => SetProperty(ref _mensagemErro, value);
    }

    public List<string> Prioridades { get; } = new List<string> { "Baixa", "Media", "Alta" };

    public ICommand CriarCommand { get; }
    public ICommand CancelarCommand { get; }

    public NovoChamadoViewModel()
    {
        _authService = new AuthService();
        Title = "Novo Chamado";
        
        CriarCommand = new Command(async () => await ExecuteCriarCommand());
        CancelarCommand = new Command(async () => await Shell.Current.GoToAsync(".."));
    }

    private async Task ExecuteCriarCommand()
    {
        if (string.IsNullOrWhiteSpace(Titulo) || string.IsNullOrWhiteSpace(Descricao))
        {
            MensagemErro = "Por favor, preencha todos os campos.";
            return;
        }

        IsBusy = true;
        MensagemErro = string.Empty;

        try
        {
            var api = _authService.GetApiService();
            var novoChamado = new CriarChamadoDto
            {
                Titulo = Titulo,
                Descricao = Descricao,
                Prioridade = Prioridade
            };

            var result = await api.CriarChamadoAsync(novoChamado);

            if (result != null)
            {
                await Shell.Current.DisplayAlert("Sucesso", $"Chamado #{result.Id} criado com sucesso!", "OK");
                await Shell.Current.GoToAsync("..");
            }
            else
            {
                MensagemErro = "Erro ao criar chamado. Tente novamente.";
            }
        }
        catch (Exception ex)
        {
            MensagemErro = $"Erro: {ex.Message}";
        }
        finally
        {
            IsBusy = false;
        }
    }
}
